<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirmació d'Assistència</title>
    <style>
        @font-face {
            font-family: 'Above the Beyond Script W00 Rg';
            src: url('Above_the_Beyond_Script_W00_Rg.woff2') format('woff2'),
                 url('Above_the_Beyond_Script_W00_Rg.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }

        /* ESTILS CSS DEL TEU FORMULARI */
        body {
            font-family: 'Above the Beyond Script W00 Rg', Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f4f4f4;
            margin: 0;
            line-height: 1.6;

            background-image: url('imatge-de-fons.jpg'); /* <-- POSA AQUÍ EL NOM DEL TEU FITXER D'IMATGE */
            background-repeat: no-repeat;
            background-position: center center;
            background-attachment: fixed;
            background-size: contain
        }
        .container {
            background-color: rgba(255, 255, 255, 0.9);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 90%;
            max-width: 550px;
        }
        h1, h2, label {
            color: #524634;
            margin-bottom: 20px;
        }
        h1 {
            font-size: 2.5em;
        }
        h2 {
            font-size: 1.5em;
        }
        input[type="text"], textarea {
            width: 80%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
            color: #524634;
        }
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        button {
            background-color: #768931;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
            transition: background-color 0.2s ease;
        }
        button:hover {
            background-color: #524634;
        }
        .message {
            margin-top: 20px;
            font-weight: bold;
            min-height: 20px;
        }
        .success {
            color: green;
        }
        .error {
            color: red;
        }
        .hidden {
            display: none !important;
        }
        .question-group {
            margin-bottom: 25px;
        }
        .question-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 1.1em;
        }
        .option-buttons button {
            background-color: #e2e6ea;
            color: #524634;
            border: 1px solid #cdd0d3;
            margin: 0 5px;
            min-width: 80px;
        }
        .option-buttons button.selected {
            background-color: #768931;
            color: white;
            border-color: #768931;
        }
        .option-buttons button:hover {
            background-color: #d1d6db;
        }
        .option-buttons button.selected:hover {
            background-color: #524634;
        }
        .final-message {
            font-size: 1.4em;
            color: #768931;
            margin-top: 30px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="formTitle">Confirma la teva assistència</h1>

        <form id="attendanceForm" target="hidden_iframe" method="POST" action="https://script.google.com/macros/s/AKfycbz3rbdd_5Y45zIiVF6W7dKgycvaKLFHoIuuOOiFVW4lz-AvOCPU9xrIHuPivQlrTD9gkQ/exec">
            <div id="nameValidationSection">
                <h2>Introdueix el teu nom i el teu primer cognom</h2>
                <input type="text" id="userNameInput" name="userName" placeholder="Nom i primer cognom">
                <button type="button" id="checkNameButton">Comprovar Nom</button>
                <div id="message1" class="message"></div>
            </div>

            <div id="attendanceQuestionSection" class="hidden question-group">
                <label>1. Assistència: Podràs assistir a la celebració?</label>
                <div class="option-buttons">
                    <button type="button" id="attendanceYes" data-value="Sí">Sí</button>
                    <button type="button" id="attendanceNo" data-value="No">No</button>
                </div>
                <input type="hidden" id="assistenciaInput" name="assistencia">
                <div id="message2" class="message"></div>
            </div>

            <div id="dietQuestionSection" class="hidden question-group">
                <label>2. Necessites una dieta especial que haguem d'informar al restaurant?</label>
                <div class="option-buttons">
                    <button type="button" id="dietYes" data-value="Sí">Sí</button>
                    <button type="button" id="dietNo" data-value="No">No</button>
                </div>
                <div id="dietTextInput" class="hidden">
                    <textarea id="dietText" name="textDieta" placeholder="Especifica la teva dieta especial aquí..."></textarea>
                </div>
                <input type="hidden" id="dietaEspecialInput" name="dietaEspecial">
                <button type="button" id="nextFromDietButton" class="hidden">Següent</button>
                <div id="message3" class="message"></div>
            </div>

            <div id="coachQuestionSection" class="hidden question-group">
                <label>3. T'interessaria utilitzar un autocar amb la ruta a Barcelona o Sabadell?</label>
                <div class="option-buttons">
                    <button type="button" id="coachBarcelona" data-value="Barcelona">Barcelona</button>
                    <button type="button" id="coachSabadell" data-value="Sabadell">Sabadell</button>
                    <button type="button" id="coachNoBus" data-value="No">No</button>
                </div>
                <input type="hidden" id="autocarInput" name="autocar">
                <input type="hidden" id="textAutocarInput" name="textAutocar">
                <div id="message4" class="message"></div>
            </div>

            <div id="commentSection" class="hidden question-group">
                <label>4. Deixa'ns el teu comentari!</label>
                <div>
                    <textarea id="commentText" name="comentari" placeholder="El teu missatge o qualsevol dubte aquí..."></textarea>
                </div>
                <button type="submit" id="submitAllAnswersButton">Finalitzar i Enviar</button>
                <div id="messageComment" class="message"></div>
            </div>

            <input type="hidden" id="missatgeFinalInput" name="missatgeFinal">

        </form>
        
        <div id="finalMessageSection" class="hidden">
            <p class="final-message" id="finalUserMessage"></p>
        </div>

    </div>

    <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;" onload="iframeLoaded()"></iframe>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz3rbdd_5Y45zIiVF6W7dKgycvaKLFHoIuuOOiFVW4lz-AvOCPU9xrIHuPivQlrTD9gkQ/exec'; // <--- Pega la URL copiada aquí

        // IMPORTANT: La URL del formulari (action) ha de ser la mateixa que SCRIPT_URL
        document.getElementById('attendanceForm').action = SCRIPT_URL;

        const hiddenNames = [
            "Laura Castarlenas",
            "Daniel Argüello",
            "Timoteo Argüello",
            "Rosa Maria Ferrer",
            "Esperança Gascons",
            "Albert Castarlenas",
            "Raquel Argüello",
            "Carlos Argüello",
            "Mireia Perez",
            "Adrian Martinez",
            "Cristofor Nogueira",
            "Helena Suròs",
            "Laia Nogueira",
            "Martí Nogueira",
            "Isabel Gascons",
            "Pilar Gascons",
            "Joan Gascons",
            "Isabel Gascons",
            "Vicenç Fauchs",
            "Albert Cardellà",
            "Aran Cardellà",
            "Elisenda Anglada",
            "Àngels Castarlenas",
            "Noemí Cardellà",
        ];

        function normalizeString(str) {
            return str
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .toLowerCase()
                .trim();
        }

        // --- Referències als elements del DOM ---
        const formTitle = document.getElementById('formTitle');
        const attendanceForm = document.getElementById('attendanceForm'); // Nova referència al formulari

        const nameValidationSection = document.getElementById('nameValidationSection');
        const attendanceQuestionSection = document.getElementById('attendanceQuestionSection');
        const dietQuestionSection = document.getElementById('dietQuestionSection');
        const coachQuestionSection = document.getElementById('coachQuestionSection');
        const commentSection = document.getElementById('commentSection');
        const finalMessageSection = document.getElementById('finalMessageSection');

        const userNameInput = document.getElementById('userNameInput');
        const checkNameButton = document.getElementById('checkNameButton');
        const message1 = document.getElementById('message1');
        const message2 = document.getElementById('message2');
        const message3 = document.getElementById('message3');
        const message4 = document.getElementById('message4');
        const messageComment = document.getElementById('messageComment');

        const attendanceYesButton = document.getElementById('attendanceYes');
        const attendanceNoButton = document.getElementById('attendanceNo');
        const assistenciaInput = document.getElementById('assistenciaInput'); // Input ocult

        const dietYesButton = document.getElementById('dietYes');
        const dietNoButton = document.getElementById('dietNo');
        const dietTextInputDiv = document.getElementById('dietTextInput');
        const dietTextarea = document.getElementById('dietText');
        const dietaEspecialInput = document.getElementById('dietaEspecialInput'); // Input ocult
        const nextFromDietButton = document.getElementById('nextFromDietButton');

        const coachBarcelonaButton = document.getElementById('coachBarcelona');
        const coachSabadellButton = document.getElementById('coachSabadell');
        const coachNoBusButton = document.getElementById('coachNoBus');
        const autocarInput = document.getElementById('autocarInput'); // Input ocult
        const textAutocarInput = document.getElementById('textAutocarInput'); // Input ocult
        
        const commentTextarea = document.getElementById('commentText');
        const submitAllAnswersButton = document.getElementById('submitAllAnswersButton');
        const missatgeFinalInput = document.getElementById('missatgeFinalInput'); // Input ocult

        const finalUserMessage = document.getElementById('finalUserMessage');

        // --- Variable per guardar l'estat del formulari (missatge final) ---
        let currentFinalMessage = '';

        // --- Funció que s'executa quan l'iframe ocult carrega una resposta ---
        function iframeLoaded() {
            // Aquesta funció s'activa quan el Apps Script envia una resposta (fins i tot si és una pàgina en blanc)
            messageComment.textContent = "Dades guardades amb èxit!";
            messageComment.className = "message success";
            
            // Amagar totes les seccions del formulari
            hideSection(nameValidationSection);
            hideSection(attendanceQuestionSection);
            hideSection(dietQuestionSection);
            hideSection(coachQuestionSection);
            hideSection(commentSection);
            
            // Mostrar la secció de missatge final
            showSection(finalMessageSection);
            finalUserMessage.textContent = currentFinalMessage; // Mostrem el missatge final que havíem guardat
            formTitle.classList.add('hidden'); // Amaguem el títol del formulari
            
            if (submitAllAnswersButton) {
                submitAllAnswersButton.disabled = false; // Habilitar el botó si s'havia deshabilitat
            }
        }
        
        // --- Lògica principal del formulari (execució pas a pas) ---

        // Pas 1: Validació del nom
        checkNameButton.addEventListener('click', () => {
            const userInput = userNameInput.value.trim();
            
            const normalizedUserInput = normalizeString(userInput);
            const nameFound = hiddenNames.some(name => normalizeString(name) === normalizedUserInput);

            if (nameFound) {
                // El valor ja està directament a userNameInput.value (gràcies a l'atribut name)
                message1.textContent = "Nom trobat! Benvingut/da.";
                message1.className = "message success";
                hideSection(nameValidationSection);
                showSection(attendanceQuestionSection);
                formTitle.textContent = "Confirma la teva assistència";
            } else {
                message1.textContent = "Nom no trobat. Torna-ho a provar.";
                message1.className = "message error";
            }
        });

        // Pas 2: Pregunta d'Assistència
        attendanceYesButton.addEventListener('click', () => {
            selectOption(attendanceQuestionSection.querySelector('.option-buttons'), attendanceYesButton, 'Sí', 'assistencia');
            assistenciaInput.value = 'Sí'; // Guarda el valor a l'input ocult
            message2.textContent = "";
            hideSection(attendanceQuestionSection);
            showSection(dietQuestionSection);
            formTitle.textContent = "Necessites una dieta especial?";
        });

        attendanceNoButton.addEventListener('click', () => {
            selectOption(attendanceQuestionSection.querySelector('.option-buttons'), attendanceNoButton, 'No', 'assistencia');
            assistenciaInput.value = 'No'; // Guarda el valor a l'input ocult
            currentFinalMessage = "Gràcies! Et trobarem a faltar."; // Guarda el missatge per mostrar al final
            missatgeFinalInput.value = currentFinalMessage; // Guarda també al camp ocult

            messageComment.textContent = "Enviant respostes..."; // Missatge mentre s'envia
            messageComment.className = "message";
            submitAllAnswersButton.disabled = true; // Deshabilitar el botó
            attendanceForm.submit(); // Envia el formulari
        });

        // Pas 3: Pregunta de Dieta Especial
        dietYesButton.addEventListener('click', () => {
            selectOption(dietQuestionSection.querySelector('.option-buttons'), dietYesButton, 'Sí', 'dietaEspecial');
            dietaEspecialInput.value = 'Sí'; // Guarda el valor a l'input ocult
            showSection(dietTextInputDiv);
            showSection(nextFromDietButton);
            message3.textContent = "";
        });

        dietNoButton.addEventListener('click', () => {
            selectOption(dietQuestionSection.querySelector('.option-buttons'), dietNoButton, 'No', 'dietaEspecial');
            dietaEspecialInput.value = 'No'; // Guarda el valor a l'input ocult
            hideSection(dietTextInputDiv);
            dietTextarea.value = ''; // Neteja el textarea
            // No cal establir formDataToSend.textDieta = '' perquè el textarea amb name="textDieta" ja s'enviarà buit
            showSection(nextFromDietButton);
            message3.textContent = "";
        });

        nextFromDietButton.addEventListener('click', () => {
            // El valor de dietTextarea.value ja es recull automàticament per l'atribut 'name'
            hideSection(dietQuestionSection);
            showSection(coachQuestionSection);
            formTitle.textContent = "Interessat en autocar?";
        });

        // Pas 4: Pregunta d'Autocar
        coachBarcelonaButton.addEventListener('click', () => {
            selectOption(coachQuestionSection.querySelector('.option-buttons'), coachBarcelonaButton, 'Sí', 'autocar');
            autocarInput.value = 'Sí'; // Guarda el valor a l'input ocult
            textAutocarInput.value = 'Barcelona'; // Guarda la ciutat a l'input ocult
            message4.textContent = "";
            hideSection(coachQuestionSection);
            showSection(commentSection);
            formTitle.textContent = "Tens algun comentari?";
        });

        coachSabadellButton.addEventListener('click', () => {
            selectOption(coachQuestionSection.querySelector('.option-buttons'), coachSabadellButton, 'Sí', 'autocar');
            autocarInput.value = 'Sí'; // Guarda el valor a l'input ocult
            textAutocarInput.value = 'Sabadell'; // Guarda la ciutat a l'input ocult
            message4.textContent = "";
            hideSection(coachQuestionSection);
            showSection(commentSection);
            formTitle.textContent = "Tens algun comentari?";
        });

        coachNoBusButton.addEventListener('click', () => {
            selectOption(coachQuestionSection.querySelector('.option-buttons'), coachNoBusButton, 'No', 'autocar');
            autocarInput.value = 'No'; // Guarda el valor a l'input ocult
            textAutocarInput.value = ''; // Buidar si no vol autocar
            message4.textContent = "";
            hideSection(coachQuestionSection);
            showSection(commentSection);
            formTitle.textContent = "Tens algun comentari?";
        });

        // Pas 5: Secció de Comentaris (i Botó Finalitzar)
        // L'enviament es fa ara pel submit del formulari
        submitAllAnswersButton.addEventListener('click', () => {
            currentFinalMessage = "Gràcies! Esperem amb molta il·lusió que arribi el dia."; // Guarda el missatge per mostrar al final
            missatgeFinalInput.value = currentFinalMessage; // Guarda al camp ocult

            messageComment.textContent = "Enviant respostes...";
            messageComment.className = "message";
            submitAllAnswersButton.disabled = true; // Deshabilitar el botó mentre s'envia
            
            // El formulari s'envia amb el type="submit" del botó i el target="hidden_iframe"
            // No cal cridar attendanceForm.submit() aquí directament si el botó és type="submit"
        });

    </script>
</body>
</html>
